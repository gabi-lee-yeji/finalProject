<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="spring.project.mapper.AdminMapper">
	
	<update id="updateRepMemStatus">
		update memberinfo 
			<set>
				status = #{status},
				<if test="status=='강제탈퇴'">
					mem_level = '',
					mem_point = 0
				</if>
			</set>
		where memid=#{memid}
	</update>
	
	<select id="getMemberInfo" resultType="spring.project.model.MemberInfoDTO">
		select * from memberinfo where memid=#{memid}
	</select>
	
	<select id="getreportMemInfo" resultType="map">
		select b.pnum, b.board_type, b.subject, a.reportcnt from 
		( select wr_num, count(*) as reportCnt from member_report where memid=#{memid} group by wr_num) a, 
		post_board b
		where
			a.wr_num=b.pnum
	</select>
	<select id="getReportMemList" resultType="spring.project.model.MemberInfoDTO">
			select * from 
				(select memid, count(*) as reportCnt from member_report group by memid) a, 
				memberinfo b 
			where 
				<![CDATA[ a.reportCnt >= 1	]]>
				and a.memid=b.memid
				<if test="status != null"> 
					and b.status = #{status} 
				</if>
			order by a.reportCnt
		
	</select>
	
	<select id="getMemberFilter" resultType="spring.project.model.MemberInfoDTO"
								parameterType="hashmap">
		select * from memberinfo  where
			<if test="search != null">
				${search} like '%${keyword}%'
			</if>
			<if test="status != null">
				and status in 
				<foreach collection="status" item="type" index="index" open="(" close=")" separator=",">
					#{type[index])
				</foreach>
			</if>
			<if test="mem_level != null">
				and mem_level in 
				<foreach collection="mem_level" item="type" index="index" open="(" close=")" separator=",">
					#{type[index])
				</foreach>
			</if>
			<if test="mem_point1 != 0">
				<![CDATA[ and mem_point >= #{mem_point1} ]]>
			</if>
			<if test="mem_point2 != 0">
				<![CDATA[ and mem_point <= #{mem_point2} ]]>
			</if>
			<if test="regDate1 != null">
				and regdate between #{regDate1} and #{regDate2}
			</if>
			order by 
	</select>
	
	<select id="getMemberCnt" resultType="int">
		select count(*) from memberinfo	
	</select>
	<select id="getMemberList" resultType="spring.project.model.MemberInfoDTO">
		select * from (select rownum r, list.* from (select * from memberInfo  
				<if test="sort != null">
					order by #{sort} #{order}
				</if>
				) list)
	</select>
	
	<select id="getSearchCnt" resultType="int">
		select count(*) from certiinfo where ${search} like '%${keyword}%'
	</select>
	<select id="getSearchList" resultType="spring.project.model.CertiInfoDTO"
								parameterType="spring.project.pagination.PagingDTO">
		select * from (select rownum r, list.* from (select 
			cnum,cname,category,clevel,cround,
			to_char(regStart,'YYYY-MM-DD') as regStart,
			to_char(regEnd,'YYYY-MM-DD') as regEnd,
			to_char(reg_addStart,'YYYY-MM-DD') as reg_addStart,
			to_char(reg_addEnd,'YYYY-MM-DD') as reg_addEnd,
			to_char(regStartTime,'HH24:MI') as regStartTime,
			to_char(regEndTime,'HH24:MI') as regEndTime,
			to_char(testDate,'YYYY-MM-DD') as testDate,
			to_char(resDate,'YYYY-MM-DD') as resDate
		from certiinfo where ${search} like '%${keyword}%') list)
        where r between #{startRow} and #{endRow}
	</select>
	
	<select id="getCertCnt" resultType="int">
		select count(*) from certiinfo
	</select>
	
	
	<update id="modCertInfo">
		update certiinfo
		<set>
			<if test="cname != null">cname=#{cname},</if>
			<if test="category != null">category=#{category},</if>
			<if test="cyear != null">cyear=#{cyear},</if>
			<if test="cround != null">cround=#{cround},</if>
			<if test="clevel != null">clevel=#{clevel},</if>
			<if test="regStart != null">
				regStart=to_date(#{regStart, jdbcType=VARCHAR},'YYYY-MM-DD'),
			</if>
			<if test="regEnd != null">
				regEnd=to_date(#{regEnd, jdbcType=VARCHAR},'YYYY-MM-DD'),
			</if>
			<if test="reg_addStart != null">
				reg_addStart=to_date(#{reg_addStart, jdbcType=VARCHAR},'YYYY-MM-DD'),
			</if>
			<if test="reg_addEnd != null">
				reg_addEnd=to_date(#{reg_addEnd, jdbcType=VARCHAR},'YYYY-MM-DD'),
			</if>
			<if test="regStartTime != null">
				regStartTime=to_date(#{regStartTime, jdbcType=VARCHAR},'HH24:MI'),
			</if>
			<if test="regEndTime != null">
				regEndTime=to_date(#{regEndTime, jdbcType=VARCHAR},'HH24:MI'),
			</if>
			<if test="testDate != null">
				testDate=to_date(#{testDate, jdbcType=VARCHAR},'YYYY-MM-DD'),
			</if>
			<if test="resDate != null">
				resDate=to_date(#{resDate, jdbcType=VARCHAR},'YYYY-MM-DD'),
			</if>
		</set>
		where cnum=#{cnum}
	</update>
	<select id="searchNatPeriod" resultType="spring.project.model.CertiDateDTO">
		select * from certidate 
		where clevel=#{clevel}
		and cyear in
		<foreach collection="cyear_list" item="cyear" open="(" separator="," close=")">
			#{cyear}
		</foreach>
		and cround in 
		<foreach collection="cround_list" item="cround" open="(" separator="," close=")">
			#{cround}
		</foreach>
	</select>
	
	<select id="searchPeriod" resultType="spring.project.model.CertiDateDTO">
		select * from certidate 
		where cnum=#{cnum}
		<!-- search certain periods -->
		<if test="search != null">
			<if test="search == docRegStart">
				and docRegStart1 between to_date(#{startDay},'YYYY-MM-DD') and to_date(#{endDay},'YYYY-MM-DD')
					or docRegStart2 between to_date(#{startDay},'YYYY-MM-DD') and to_date(#{endDay},'YYYY-MM-DD')
			</if>
			<if test="search == docTestStart">
				and docTestStart between to_date(#{startDay},'YYYY-MM-DD') and to_date(#{endDay},'YYYY-MM-DD')
			</if>
			<if test="search == pracRegStart">
				and pracRegStart1 between to_date(#{startDay},'YYYY-MM-DD') and to_date(#{endDay},'YYYY-MM-DD')
					or pracRegStart2 between to_date(#{startDay},'YYYY-MM-DD') and to_date(#{endDay},'YYYY-MM-DD')
			</if>
			<if test="search == pracTestStart">
				and pracTestStart between to_date(#{startDay},'YYYY-MM-DD') and to_date(#{endDay},'YYYY-MM-DD')
			</if>
		</if>
	</select>
	<select id="getCertiReqInfo" resultType="spring.project.model.CertiRequirementDTO">
		select * from certi_requirement where cnum=#{cnum}
	</select>
	<select id="getQnetDate" resultType="spring.project.model.CertiDateDTO"
							parameterType="spring.project.model.CertiScheduleDTO">
		select * from certidate 
			where cyear=#{cyear}
			and cround=#{cround}
			and clevel=#{clevel}						
	</select>
	<select id="getQnetDateInfo" resultType="spring.project.model.CertiScheduleDTO">
		select * from certischedule where cnum=#{cnum}
	</select>
	<select id="getCertiDate" resultType="spring.project.model.CertiDateDTO">
		select * from certidate
	</select>
	<select id="getCertiInfo" resultType="spring.project.model.CertiInfoDTO">
		select * from certiinfo where cnum=#{cnum}
	</select>
	
	<select id="findNextseq" resultType="int">
		select ${sequence}.nextval from dual
	</select>
	
	<select id="findCurrseq" resultType="int">
		select last_number from seq
		where sequence_name = #{sequence}
	</select>
	
	<select id="getCertList" resultType="spring.project.model.CertiInfoDTO">
		select * from (select rownum r, list.* from (select *
		from certiinfo 
			<if test="sort != null and sort != 'null' and sort != '' ">
				order by ${sort} ${order}
			</if>
			<if test="sort==null or sort=='' or sort == 'null' ">
				order by cnum asc
			</if>
			nulls last) list)
        where r between #{startRow} and #{endRow}
        <if	test="category != null and category != ''">
        	and category = #{category}
        </if>
	</select>
	
	<select id="getDelList" resultType="spring.project.model.CertiInfoDTO"> 
		select 
			cnum,cname,category,clevel,cround,
			to_char(regStart,'YYYY-MM-DD') as regStart,
			to_char(regEnd,'YYYY-MM-DD') as regEnd,
			to_char(reg_addStart,'YYYY-MM-DD') as reg_addStart,
			to_char(reg_addEnd,'YYYY-MM-DD') as reg_addEnd,
			to_char(regStartTime,'HH24:MI') as regStartTime,
			to_char(regEndTime,'HH24:MI') as regEndTime,
			to_char(testDate,'YYYY-MM-DD') as testDate,
			to_char(resDate,'YYYY-MM-DD') as resDate
		from certiinfo where cnum in 
		<foreach collection="array" item="cnum" open="(" separator="," close=")">
			#{cnum}
		</foreach>
		order by cnum
	</select>
	
	<delete id="delCertiInfo">
		delete from certiinfo where cnum in
		<foreach collection="array" item="cnum" open="(" separator="," close=")">
			#{cnum}
		</foreach>
	</delete>
	<delete id="delCertiDetail">
		delete from certidetail where cnum in
		<foreach collection="array" item="cnum" open="(" separator="," close=")">
			#{cnum}
		</foreach>
	</delete>
	
	<insert id="addCertiReq">
		insert into certi_requirement(
			#{cnum},
			#{req_degree},
			#{req_age},
			#{req_exp},
			#{pre_requisite},
			#{ref}
		)
	</insert>
	
	<insert id="addCertiSchedule">
		insert into certiSchedule values (
			#{cnum},
			#{cyear,jdbcType=INTEGER},
			nvl(#{cround}, 0),
			#{clevel},
			sysdate
		)
	</insert>
	
	<insert id="addCertiInfo">
		insert into certiInfo values (
			#{cnum},
			#{cname},
			#{category},
			#{clevel,jdbcType=VARCHAR},
			#{company,jdbcType=VARCHAR},
			#{website,jdbcType=VARCHAR},
			#{requirement,jdbcType=VARCHAR},
			#{cmethod,jdbcType=VARCHAR},
			#{subject,jdbcType=VARCHAR},
			#{cutline,jdbcType=VARCHAR},
			#{cinfo,jdbcType=VARCHAR},
			#{cjob,jdbcType=VARCHAR},
			to_date(#{expiry, jdbcType=VARCHAR},'YYYY-MM-DD'),
			#{status, jdbcType=VARCHAR},
			#{price, jdbcType=VARCHAR},
			#{ncs_cat,jdbcType=VARCHAR},
			#{notice, jdbcType=VARCHAR},
			sysdate
		)
	</insert>
	
	<insert id="addCertiDate" parameterType="spring.project.model.CertiDateDTO">
		insert into certidate values(
			#{cnum, jdbcType=VARCHAR},
			#{cyear},
			#{cround},
			#{clevel},
			TO_DATE(#{docRegStart1},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{docRegEnd1},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{docRegStart2},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{docRegEnd2},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{docTestStart},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{docTestEnd},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{docResultStart},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{docResultEnd},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{docSubmitStart},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{docSubmitEnd},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{pracRegStart1},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{pracRegEnd1},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{pracRegStart2},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{pracRegEnd2},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{pracTestStart},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{pracTestEnd},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{pracResStart},'YYYY-MM-DD HH24:MI'),
			TO_DATE(#{pracResEnd},'YYYY-MM-DD HH24:MI'),
			CERTIDATE_SEQ.nextval
		)
	</insert>
	
</mapper>